<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="screen-orientation" content="portrait">
  <title>Water Drop Survivor</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #FFF0F5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #game-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* HUD */
    .hud-top {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .bar-container {
      width: 200px;
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 2px solid #fff;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      width: 100%;
      transition: width 0.2s;
    }

    #hp-fill { background: #FF69B4; width: 100%; }
    #exp-fill { background: #4ECDC4; width: 0%; }

    .stat-text {
      color: #FF69B4;
      font-weight: bold;
      text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
      font-size: 14px;
    }

    /* Joystick Area */
    #joystick-zone {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 150px;
      pointer-events: auto;
      touch-action: none;
    }

    /* LEVEL UP MODAL - DOPAMIN VERSION */
    #levelup-modal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      z-index: 100;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 25px;
      border: 5px solid #b22222;
      width: 85%;
      max-width: 450px;
      text-align: center;
      box-shadow: 0 0 30px rgba(178, 34, 34, 0.5);
    }

    #upgrade-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .upgrade-card {
      background: #2c2c2c;
      padding: 15px;
      border-radius: 15px;
      border: 2px solid #444;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .upgrade-card:hover {
      transform: scale(1.05);
      background: #333;
      border-color: #b22222;
    }

    .upgrade-title {
      font-weight: bold;
      color: #f5f5dc;
      font-size: 18px;
      text-transform: uppercase;
    }

    .upgrade-desc {
      font-size: 13px;
      color: #ff6b6b;
      margin-top: 4px;
    }

    .damage-number {
      position: absolute;
      color: #fff;
      font-weight: bold;
      font-size: 20px;
      pointer-events: none;
      text-shadow: 0 0 3px #FF0000;
      animation: floatUp 1s forwards;
    }

    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }

    #gameover-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      z-index: 30;
      color: white;
    }

    .btn {
      background: #FF69B4;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 20px;
      border-radius: 50px;
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="game-container"></div>

  <div id="ui-layer">
    <div class="hud-top">
      <div class="bar-container">
        <div class="bar-fill" id="hp-fill"></div>
      </div>
      <div class="stat-text" id="hp-text">HP: 100/100</div>
      
      <div class="bar-container" style="border-color: #4ECDC4;">
        <div class="bar-fill" id="exp-fill"></div>
      </div>
      <div class="stat-text" id="lvl-text" style="color: #4ECDC4;">LVL: 1</div>
      <div class="stat-text" id="score-text" style="color: #9370DB;">KILLS: 0</div>
    </div>
    <div id="joystick-zone"></div>
  </div>

  <div id="levelup-modal">
    <div class="modal-content">
      <h2 style="color: #f5f5dc; margin-bottom: 20px;">NEW POWER UNLOCKED</h2>
      <div id="upgrade-list"></div>
    </div>
  </div>

  <div id="gameover-screen">
    <h1 style="color: #FF69B4; font-size: 40px;">GAME OVER</h1>
    <p id="final-score">Kills: 0</p>
    <button class="btn" onclick="location.reload()">TRY AGAIN</button>
  </div>

  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.176.0/build/three.module.js"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';

    // --- CONSTANTS & CONFIG ---
    const COLORS = {
      bg: 0xFFF0F5,
      player: 0x4ECDC4,
      enemySquare: 0xFF69B4,
      enemyTriangle: 0xFFD700,
      enemyRound: 0x9370DB,
      ground: 0x7CFC00,
      forest: 0x98FB98,
      lake: 0x1E90FF,
      cabin: 0xDEB887,
      exp: 0x00FFFF,
    };

    let scene, camera, renderer, player;
    let enemies = [], projectiles = [], expGems = [], particles = [], meteors = [];
    let lastTime = 0, frameCount = 0, isPaused = false, isGameOver = false, gameTime = 0;
    
    const joystick = { x: 0, y: 0, active: false, id: null, originX: 0, originY: 0 };
    const playerStats = {
      lvl: 1, exp: 0, expReq: 20, hp: 100, maxHp: 100,
      strength: 1, armor: 0, speed: 1, critChance: 0.1, critDmg: 1.5,
      damage: 1, atkSpeed: 1, walkSpeed: 25, kills: 0, hpRegen: 0
    };

    const weapons = {
      gun: { active: true, damage: 15, cooldown: 1000, lastShot: 0, range: 12, barrels: 1 },
      sword: { active: false, damage: 30, cooldown: 1500, lastShot: 0, range: 3.5 },
      aura: { active: false, damage: 5, cooldown: 500, lastShot: 0, range: 4, mesh: null },
      meteor: { active: false, damage: 100, cooldown: 3000, lastShot: 0 }
    };

    class Player {
      constructor() {
        const geometry = new THREE.SphereGeometry(0.5, 32, 32);
        const material = new THREE.MeshToonMaterial({ color: COLORS.player });
        this.mesh = new THREE.Mesh(geometry, material);
        this.mesh.position.y = 0.5;
        this.mesh.castShadow = true;
        scene.add(this.mesh);
        this.velocity = new THREE.Vector3();
      }

      update(dt) {
        if (joystick.active) {
          const speed = 0.12 * (playerStats.walkSpeed / 25);
          this.mesh.position.x += joystick.x * speed;
          this.mesh.position.z += joystick.y * speed;
          this.mesh.rotation.y = Math.atan2(joystick.x, joystick.y);
          
          // Walking ripples/droplets
          if (frameCount % 10 === 0) {
            spawnParticles(this.mesh.position, COLORS.player, 1, false);
          }
        }
        
        // Physics squash
        const speedMag = joystick.active ? 1 : 0;
        const stretch = 1 + (speedMag * 0.2);
        const squash = 1 / Math.sqrt(stretch);
        this.mesh.scale.set(squash, squash, stretch);

        camera.position.x = this.mesh.position.x + 20;
        camera.position.z = this.mesh.position.z + 20;
        camera.lookAt(this.mesh.position);
      }

      takeDamage(amount) {
        const reduced = Math.max(1, amount * (1 - playerStats.armor / 100));
        playerStats.hp -= reduced;
        updateHUD();
        // BIG WATER SPLASH
        spawnParticles(this.mesh.position, COLORS.player, 15, true);
        if (playerStats.hp <= 0) gameOver();
      }
    }

    class Particle {
      constructor(pos, color, isBig) {
        const size = isBig ? 0.15 : 0.05;
        const geo = new THREE.SphereGeometry(size, 8, 8);
        const mat = new THREE.MeshBasicMaterial({ color: color });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.copy(pos);
        this.vel = new THREE.Vector3((Math.random()-0.5)*0.2, Math.random()*0.2, (Math.random()-0.5)*0.2);
        if(isBig) this.vel.multiplyScalar(2);
        this.life = 60;
        scene.add(this.mesh);
      }
      update() {
        this.mesh.position.add(this.vel);
        this.vel.y -= 0.01; // Gravity
        if(this.mesh.position.y < 0.05) {
          this.mesh.position.y = 0.05;
          this.vel.set(0,0,0); // Land on ground
        }
        this.life--;
        if(this.life <= 0) {
          scene.remove(this.mesh);
          return false;
        }
        return true;
      }
    }

    function spawnParticles(pos, color, count, isBig) {
      for(let i=0; i<count; i++) particles.push(new Particle(pos, color, isBig));
    }

    function createWorld() {
      const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshToonMaterial({ color: COLORS.ground }));
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      const lake = new THREE.Mesh(new THREE.CircleGeometry(15, 32), new THREE.MeshToonMaterial({ color: COLORS.lake }));
      lake.rotation.x = -Math.PI / 2;
      lake.position.set(30, 0.01, -30);
      scene.add(lake);
      
      // Windmill
      const wm = new THREE.Group();
      const base = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 8), new THREE.MeshToonMaterial({color: 0xD2B48C}));
      base.position.y = 4;
      wm.add(base);
      const blades = new THREE.Mesh(new THREE.BoxGeometry(12, 1, 1), new THREE.MeshToonMaterial({color: 0x8B4513}));
      blades.position.set(0, 7, 2);
      wm.add(blades);
      wm.position.set(-30, 0, 30);
      wm.userData.blades = blades;
      scene.add(wm);
    }

    function showUpgradeModal() {
      isPaused = true;
      const modal = document.getElementById('levelup-modal');
      const list = document.getElementById('upgrade-list');
      list.innerHTML = '';
      
      let pool = [
        { name: "Gunner", sub: "Gun Damage +15%", fn: () => { weapons.gun.damage += 10; } },
        { name: "Hydra Strength", sub: "Overall Damage +20%", fn: () => { playerStats.strength += 0.2; } },
        { name: "Hardened Shell", sub: "Armor +15%", fn: () => { playerStats.armor += 15; } },
        { name: "Flow Speed", sub: "Move Speed +10%", fn: () => { playerStats.walkSpeed += 3; } },
        { name: "Rapid Pulse", sub: "Attack Speed +20%", fn: () => { playerStats.atkSpeed += 0.2; } },
        { name: "Deep Water", sub: "Max HP +25", fn: () => { playerStats.maxHp += 25; playerStats.hp += 25; } }
      ];

      // Fixa vapen-progression vid specifika levels
      if (playerStats.lvl === 5) pool = [{ name: "Hydra Blade", sub: "New: Sword Slash", fn: () => weapons.sword.active = true }];
      if (playerStats.lvl === 10) pool = [{ name: "Twin Stream", sub: "Gun: Double Barrel", fn: () => weapons.gun.barrels = 2 }];
      if (playerStats.lvl === 15) pool = [{ name: "Oceanic Aura", sub: "New: Damage Ring", fn: () => {
          weapons.aura.active = true;
          const auraGeo = new THREE.RingGeometry(3.8, 4, 32);
          const auraMat = new THREE.MeshBasicMaterial({ color: 0x4ECDC4, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
          weapons.aura.mesh = new THREE.Mesh(auraGeo, auraMat);
          weapons.aura.mesh.rotation.x = Math.PI/2;
          scene.add(weapons.aura.mesh);
      }}];
      if (playerStats.lvl === 20) pool = [{ name: "Meteor Strike", sub: "New: Sky Fire", fn: () => weapons.meteor.active = true }];

      // Alltid 4 val (fyll ut om det Ã¤r level-uniques)
      let choices = pool.sort(() => 0.5 - Math.random()).slice(0, 4);
      while(choices.length < 4) choices.push(choices[0]);

      choices.forEach(u => {
        const card = document.createElement('div');
        card.className = 'upgrade-card';
        card.innerHTML = `<div class="upgrade-title">${u.name}</div><div class="upgrade-desc">${u.sub}</div>`;
        card.onclick = () => {
          u.fn();
          modal.style.display = 'none';
          isPaused = false;
          updateHUD();
        };
        list.appendChild(card);
      });
      modal.style.display = 'flex';
    }

    function setupInputs() {
      const zone = document.getElementById('joystick-zone');
      zone.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        joystick.active = true;
        joystick.originX = touch.clientX;
        joystick.originY = touch.clientY;
      });
      zone.addEventListener('touchmove', (e) => {
        if(!joystick.active) return;
        const touch = e.touches[0];
        const dx = touch.clientX - joystick.originX;
        const dy = touch.clientY - joystick.originY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const max = 50;
        joystick.x = (dx/dist) * (Math.min(dist, max)/max);
        joystick.y = (dy/dist) * (Math.min(dist, max)/max);
      });
      zone.addEventListener('touchend', () => { joystick.active = false; joystick.x = 0; joystick.y = 0; });
    }

    function animate(time) {
      requestAnimationFrame(animate);
      if (isPaused) return;
      const dt = (time - lastTime) / 1000;
      lastTime = time;
      frameCount++;

      player.update(dt);

      // Weapon: Aura Position
      if(weapons.aura.active && weapons.aura.mesh) {
        weapons.aura.mesh.position.copy(player.mesh.position);
        weapons.aura.mesh.position.y = 0.1;
        weapons.aura.mesh.rotation.z += 0.02;
        if(frameCount % 30 === 0) {
          enemies.forEach(e => {
            if(player.mesh.position.distanceTo(e.mesh.position) < weapons.aura.range) {
              e.hp -= weapons.aura.damage * playerStats.strength;
            }
          });
        }
      }

      // Enemy Spawn
      if (frameCount % 100 === 0) {
        const ang = Math.random() * Math.PI*2;
        const e = {
          mesh: new THREE.Mesh(new THREE.BoxGeometry(0.7,0.7,0.7), new THREE.MeshToonMaterial({color: COLORS.enemySquare})),
          hp: 40 + (playerStats.lvl * 5)
        };
        e.mesh.position.set(player.mesh.position.x + Math.cos(ang)*20, 0.5, player.mesh.position.z + Math.sin(ang)*20);
        scene.add(e.mesh);
        enemies.push(e);
      }

      // Updates
      enemies.forEach((e, i) => {
        const dir = new THREE.Vector3().subVectors(player.mesh.position, e.mesh.position).normalize();
        e.mesh.position.addScaledVector(dir, 0.06);
        if(e.mesh.position.distanceTo(player.mesh.position) < 0.8) {
          player.takeDamage(25);
          e.hp = 0;
        }
        if(e.hp <= 0) {
          playerStats.exp += 10;
          playerStats.kills++;
          if(playerStats.exp >= playerStats.expReq) {
            playerStats.exp = 0;
            playerStats.lvl++;
            playerStats.expReq += 15;
            showUpgradeModal();
          }
          scene.remove(e.mesh);
          enemies.splice(i, 1);
          updateHUD();
        }
      });

      particles = particles.filter(p => p.update());

      renderer.render(scene, camera);
    }

    function updateHUD() {
      document.getElementById('hp-fill').style.width = (playerStats.hp/playerStats.maxHp)*100 + "%";
      document.getElementById('exp-fill').style.width = (playerStats.exp/playerStats.expReq)*100 + "%";
      document.getElementById('hp-text').innerText = `HP: ${Math.ceil(playerStats.hp)}`;
      document.getElementById('lvl-text').innerText = `LVL: ${playerStats.lvl}`;
      document.getElementById('score-text').innerText = `KILLS: ${playerStats.kills}`;
    }

    function gameOver() {
      isPaused = true;
      document.getElementById('gameover-screen').style.display = 'flex';
      document.getElementById('final-score').innerText = `Kills: ${playerStats.kills}`;
    }

    // Init
    scene = new THREE.Scene();
    scene.background = new THREE.Color(COLORS.bg);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('game-container').appendChild(renderer.domElement);
    init();
    player = new Player();
  </script>
</body>
</html>
