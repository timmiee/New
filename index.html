<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Water Drop Survivor - Enhanced FX</title>
  <style>
    body {
      margin: 0; padding: 0; overflow: hidden;
      background-color: #FFF0F5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      touch-action: none; user-select: none; -webkit-user-select: none;
    }
    #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
    }
    .hud-top { padding: 20px; display: flex; flex-direction: column; gap: 8px; }
    .bar-container {
      width: 180px; height: 16px; background: rgba(0, 0, 0, 0.2);
      border-radius: 10px; border: 2px solid #fff; overflow: hidden; position: relative;
    }
    .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
    #hp-bar .bar-fill { background: #FF69B4; }
    #exp-bar .bar-fill { background: #4ECDC4; width: 0%; }
    .stat-text {
      color: #FF69B4; font-weight: bold; font-size: 14px;
      text-shadow: 1px 1px 0 #fff;
    }
    #joystick-zone {
      position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
      width: 120px; height: 120px; pointer-events: auto;
    }
    #levelup-modal, #stats-modal, #gameover-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; align-items: center; justify-content: center;
      flex-direction: column; z-index: 20; pointer-events: auto;
    }
    #levelup-modal { background: rgba(255, 240, 245, 0.8); }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 20px;
      border: 4px solid #FF69B4; width: 80%; max-width: 350px; text-align: center;
    }
    .upgrade-card {
      margin: 8px 0; padding: 12px; border-radius: 12px; cursor: pointer;
      font-weight: bold; border: 2px solid rgba(0,0,0,0.1);
    }
    .damage-number {
      position: absolute; color: #fff; font-weight: 900; font-size: 22px;
      pointer-events: none; text-shadow: 2px 2px 0 #000;
      animation: floatUp 0.8s ease-out forwards;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
    }
    .btn {
      background: #FF69B4; color: white; border: none; padding: 12px 24px;
      border-radius: 50px; font-weight: bold; margin-top: 15px;
    }
  </style>
</head>
<body>

  <div id="game-container"></div>

  <div id="ui-layer">
    <div class="hud-top">
      <div class="bar-container"><div class="bar-fill" id="hp-fill" style="background:#FF69B4;"></div></div>
      <div class="stat-text" id="hp-text">HP: 100/100</div>
      <div class="bar-container" style="border-color:#4ECDC4;"><div class="bar-fill" id="exp-fill" style="background:#4ECDC4;"></div></div>
      <div class="stat-text" id="lvl-text" style="color:#4ECDC4;">LVL: 1</div>
      <div class="stat-text" id="score-text" style="color:#9370DB;">KILLS: 0</div>
    </div>
    <div id="joystick-zone"></div>
  </div>

  <div id="levelup-modal"><div class="modal-content"><h2>LEVEL UP!</h2><div id="upgrade-list"></div></div></div>
  
  <div id="gameover-screen" style="background:rgba(0,0,0,0.8); color:white;">
    <h1>GAME OVER</h1>
    <p id="final-score"></p>
    <button class="btn" onclick="location.reload()">RESTART</button>
  </div>

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.176.0/build/three.module.js" } }
  </script>

  <script type="module">
    import * as THREE from 'three';

    // --- CONFIG & COLORS ---
    const COLORS = {
      player: 0x4ECDC4,
      enemySquare: 0xFF69B4,
      enemyTriangle: 0xFFD700,
      enemyRound: 0x9370DB,
      ground: 0x7CFC00,
      lake: 0x1E90FF,
      forest: 0x228B22,
      exp: 0xFFFF00
    };

    let scene, camera, renderer, player;
    let enemies = [], projectiles = [], expGems = [], particles = [], meteors = [];
    let isPaused = false, isGameOver = false, frameCount = 0;
    
    const joystick = { x: 0, y: 0, active: false, originX: 0, originY: 0, id: null };
    const playerStats = { 
      lvl: 1, exp: 0, expReq: 20, hp: 100, maxHp: 100, 
      strength: 1, speed: 1, armor: 0, kills: 0, walkSpeed: 25, critChance: 0.1 
    };
    
    const weapons = {
      gun: { active: true, damage: 15, cooldown: 1000, lastShot: 0, range: 12 },
      sword: { active: false, damage: 30, cooldown: 1200, lastShot: 0, range: 4 },
      aura: { active: false, damage: 2, cooldown: 500, lastShot: 0, range: 4 },
      meteor: { active: false, damage: 100, cooldown: 3000, lastShot: 0 }
    };

    // --- UTILS: PARTICLES (THE "DROPS" & EFFECTS) ---
    class Particle {
      constructor(pos, color, scale = 0.2, speed = 0.2) {
        const geo = new THREE.SphereGeometry(scale, 4, 4);
        const mat = new THREE.MeshBasicMaterial({ color: color });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.copy(pos);
        scene.add(this.mesh);
        
        this.vel = new THREE.Vector3(
          (Math.random() - 0.5) * speed,
          Math.random() * speed,
          (Math.random() - 0.5) * speed
        );
        this.life = 40 + Math.random() * 20;
      }
      update() {
        this.life--;
        this.mesh.position.add(this.vel);
        this.vel.y -= 0.01; // Gravity
        if(this.mesh.position.y < 0.1) {
            this.mesh.position.y = 0.1;
            this.vel.set(0,0,0);
        }
        if(this.life <= 0) {
          scene.remove(this.mesh);
          return false;
        }
        return true;
      }
    }

    function spawnHitEffect(pos, color, count = 5) {
      for(let i=0; i<count; i++) {
        particles.push(new Particle(pos, color, 0.15, 0.3));
      }
    }

    // --- CLASSES ---
    class Player {
      constructor() {
        const geo = new THREE.SphereGeometry(0.6, 16, 16);
        const mat = new THREE.MeshToonMaterial({ color: COLORS.player });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.y = 0.6;
        scene.add(this.mesh);
        this.velocity = new THREE.Vector3();
      }
      update() {
        if (joystick.active) {
          const moveX = joystick.x * 0.15 * (playerStats.walkSpeed / 25);
          const moveZ = joystick.y * 0.15 * (playerStats.walkSpeed / 25);
          this.mesh.position.x += moveX;
          this.mesh.position.z += moveZ;
          this.mesh.rotation.y = Math.atan2(joystick.x, joystick.y);
          
          // Squishy animation
          const s = 1 + Math.sin(Date.now() * 0.01) * 0.1;
          this.mesh.scale.set(1/s, s, 1/s);
        } else {
          this.mesh.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
        }
        camera.position.set(this.mesh.position.x, 15, this.mesh.position.z + 12);
        camera.lookAt(this.mesh.position);
      }
      takeDamage(dmg) {
        const actualDmg = dmg * (1 - playerStats.armor/100);
        playerStats.hp -= actualDmg;
        spawnHitEffect(this.mesh.position, COLORS.player, 8); // Loses droplets
        updateUI();
        if(playerStats.hp <= 0) gameOver();
      }
    }

    class Enemy {
      constructor(type, x, z) {
        this.type = type;
        let geo;
        this.color = type === 0 ? COLORS.enemySquare : (type === 1 ? COLORS.enemyTriangle : COLORS.enemyRound);
        if(type === 0) geo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        else if(type === 1) geo = new THREE.ConeGeometry(0.5, 1, 4);
        else geo = new THREE.SphereGeometry(0.5, 12, 12);
        
        this.mesh = new THREE.Mesh(geo, new THREE.MeshToonMaterial({ color: this.color }));
        this.mesh.position.set(x, 0.5, z);
        scene.add(this.mesh);
        this.hp = 100;
        this.speed = 0.04 + Math.random() * 0.02;
      }
      update() {
        const dir = new THREE.Vector3().subVectors(player.mesh.position, this.mesh.position).normalize();
        this.mesh.position.add(dir.multiplyScalar(this.speed));
        if(this.mesh.position.distanceTo(player.mesh.position) < 0.8) {
          player.takeDamage(0.5); // Melee dmg over time
        }
      }
      hit(dmg) {
        this.hp -= dmg;
        // FX: Flash white
        const originalColor = this.color;
        this.mesh.material.color.set(0xffffff);
        setTimeout(() => this.mesh.material.color.set(originalColor), 50);
        
        // FX: Particles
        spawnHitEffect(this.mesh.position, this.color, 4);
        createDmgText(dmg, this.mesh.position);

        if(this.hp <= 0) this.die();
      }
      die() {
        spawnHitEffect(this.mesh.position, this.color, 15); // Big death splash
        spawnExp(this.mesh.position);
        scene.remove(this.mesh);
        enemies = enemies.filter(e => e !== this);
        playerStats.kills++;
        updateUI();
      }
    }

    class Bullet {
        constructor(pos, targetPos) {
            this.mesh = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color: 0xfff000}));
            this.mesh.position.copy(pos);
            scene.add(this.mesh);
            this.dir = new THREE.Vector3().subVectors(targetPos, pos).normalize();
            this.life = 100;
        }
        update() {
            this.mesh.position.add(this.dir.clone().multiplyScalar(0.4));
            this.life--;
            enemies.forEach(e => {
                if(this.mesh.position.distanceTo(e.mesh.position) < 0.8) {
                    let dmg = weapons.gun.damage * playerStats.strength;
                    if(Math.random() < playerStats.critChance) dmg *= 2;
                    e.hit(Math.floor(dmg));
                    this.life = 0;
                }
            });
            if(this.life <= 0) { scene.remove(this.mesh); return false; }
            return true;
        }
    }

    // --- CORE ENGINE ---
    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xFFF0F5);
      camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('game-container').appendChild(renderer.domElement);

      const amb = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(amb);
      const sun = new THREE.DirectionalLight(0xffffff, 0.5);
      sun.position.set(10, 20, 10);
      scene.add(sun);

      // Ground
      const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshToonMaterial({ color: COLORS.ground }));
      ground.rotation.x = -Math.PI/2;
      scene.add(ground);

      player = new Player();
      setupInputs();
      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      if(isPaused || isGameOver) return;

      frameCount++;
      player.update();

      // Weapon Logic
      if(frameCount % 60 === 0) { // Gun auto-fire
        let nearest = null, minDist = weapons.gun.range;
        enemies.forEach(e => {
            const d = e.mesh.position.distanceTo(player.mesh.position);
            if(d < minDist) { minDist = d; nearest = e; }
        });
        if(nearest) projectiles.push(new Bullet(player.mesh.position, nearest.mesh.position));
      }

      // Aura Logic
      if(weapons.aura.active && frameCount % 20 === 0) {
        enemies.forEach(e => {
          if(e.mesh.position.distanceTo(player.mesh.position) < weapons.aura.range) e.hit(weapons.aura.damage);
        });
      }

      // Spawning
      if(frameCount % 120 === 0) {
        const angle = Math.random() * Math.PI * 2;
        enemies.push(new Enemy(Math.floor(Math.random()*3), player.mesh.position.x + Math.cos(angle)*15, player.mesh.position.z + Math.sin(angle)*15));
      }

      // Updates
      enemies.forEach(e => e.update());
      projectiles = projectiles.filter(p => p.update());
      particles = particles.filter(p => p.update());
      expGems.forEach(g => {
          if(g.position.distanceTo(player.mesh.position) < 4) g.position.lerp(player.mesh.position, 0.2);
          if(g.position.distanceTo(player.mesh.position) < 0.6) {
              scene.remove(g);
              expGems = expGems.filter(gem => gem !== g);
              addExp(10);
          }
      });

      renderer.render(scene, camera);
    }

    // --- UI & LOGIC ---
    function spawnExp(pos) {
        const gem = new THREE.Mesh(new THREE.OctahedronGeometry(0.2), new THREE.MeshBasicMaterial({color: COLORS.exp}));
        gem.position.set(pos.x, 0.2, pos.z);
        scene.add(gem);
        expGems.push(gem);
    }

    function addExp(amt) {
        playerStats.exp += amt;
        if(playerStats.exp >= playerStats.expReq) {
            playerStats.lvl++;
            playerStats.exp = 0;
            playerStats.expReq += 20;
            showLevelUp();
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('hp-fill').style.width = (playerStats.hp/playerStats.maxHp)*100 + "%";
        document.getElementById('hp-text').innerText = `HP: ${Math.ceil(playerStats.hp)}/${playerStats.maxHp}`;
        document.getElementById('exp-fill').style.width = (playerStats.exp/playerStats.expReq)*100 + "%";
        document.getElementById('lvl-text').innerText = `LVL: ${playerStats.lvl}`;
        document.getElementById('score-text').innerText = `KILLS: ${playerStats.kills}`;
    }

    function createDmgText(amt, pos) {
        const div = document.createElement('div');
        div.className = 'damage-number';
        div.innerText = amt;
        const vector = pos.clone().project(camera);
        div.style.left = (vector.x * .5 + .5) * window.innerWidth + 'px';
        div.style.top = (-(vector.y * .5) + .5) * window.innerHeight + 'px';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 800);
    }

    function showLevelUp() {
        isPaused = true;
        const modal = document.getElementById('levelup-modal');
        const list = document.getElementById('upgrade-list');
        list.innerHTML = "";
        
        const ups = [
            { t: "STRENGTH", d: "Damage +20%", a: () => playerStats.strength += 0.2, c: "#000" },
            { t: "ARMOR", d: "Defense +10%", a: () => playerStats.armor += 10, c: "#808080" },
            { t: "AURA", d: "Burn nearby enemies", a: () => weapons.aura.active = true, c: "#FFFF00" },
            { t: "SPEED", d: "Move Faster", a: () => playerStats.walkSpeed += 5, c: "#FF0000" }
        ];

        ups.forEach(u => {
            const card = document.createElement('div');
            card.className = 'upgrade-card';
            card.style.backgroundColor = u.c;
            card.style.color = "#fff";
            card.innerHTML = `<div>${u.t}</div><div style='font-size:10px'>${u.d}</div>`;
            card.onclick = () => { u.a(); isPaused = false; modal.style.display='none'; };
            list.appendChild(card);
        });
        modal.style.display = 'flex';
    }

    function gameOver() {
        isGameOver = true;
        document.getElementById('gameover-screen').style.display = 'flex';
        document.getElementById('final-score').innerText = `Kills: ${playerStats.kills} - Level: ${playerStats.lvl}`;
    }

    function setupInputs() {
        const zone = document.getElementById('joystick-zone');
        zone.addEventListener('touchstart', e => {
            const t = e.touches[0];
            joystick.active = true;
            joystick.originX = t.clientX;
            joystick.originY = t.clientY;
            joystick.id = t.identifier;
        });
        window.addEventListener('touchmove', e => {
            if(!joystick.active) return;
            const t = Array.from(e.touches).find(touch => touch.identifier === joystick.id);
            if(t) {
                const dx = t.clientX - joystick.originX;
                const dy = t.clientY - joystick.originY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const max = 40;
                joystick.x = dx / (dist > max ? dist/max : 1) / max;
                joystick.y = dy / (dist > max ? dist/max : 1) / max;
            }
        });
        window.addEventListener('touchend', () => { joystick.active = false; joystick.x = 0; joystick.y = 0; });
    }

    init();
  </script>
</body>
</html>
