<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Water Drop Survivor - Updated</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #FFF0F5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #game-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }

    /* HUD Elements */
    .hud-top {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bar-container {
      width: 180px;
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 2px solid #fff;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    #hp-fill { background: #FF69B4; }
    #exp-fill { background: #4ECDC4; }

    .stat-text {
      color: #fff;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      font-size: 14px;
    }

    /* Joystick Area */
    #joystick-zone {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.3);
      pointer-events: auto;
    }

    /* Modals */
    #levelup-modal, #gameover-screen, #stats-modal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      z-index: 100;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 20px;
      width: 85%;
      max-width: 350px;
      text-align: center;
    }

    .upgrade-card {
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      transition: transform 0.1s;
      text-align: left;
    }

    .upgrade-card:active { transform: scale(0.96); }

    .upgrade-title { font-weight: bold; font-size: 1.1em; }
    .upgrade-desc { font-size: 0.85em; opacity: 0.9; }

    .btn {
      background: #FF69B4;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: bold;
      margin-top: 15px;
    }

    .damage-number {
      position: absolute;
      color: #FF4500;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 0.8s forwards;
    }

    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-40px); opacity: 0; }
    }
  </style>
</head>
<body>

  <div id="game-container"></div>

  <div id="ui-layer">
    <div class="hud-top">
      <div class="bar-container"><div id="hp-fill" class="bar-fill"></div></div>
      <div id="hp-text" class="stat-text">HP: 100/100</div>
      <div class="bar-container" style="border-color: #4ECDC4;"><div id="exp-fill" class="bar-fill"></div></div>
      <div id="lvl-text" class="stat-text" style="color: #4ECDC4;">LVL: 1</div>
    </div>
    <div id="joystick-zone"></div>
    <button id="stats-btn" style="position: absolute; top: 20px; right: 20px; pointer-events: auto; background: none; border: 2px solid #fff; color: #fff; border-radius: 5px; padding: 5px 10px;">STATS</button>
  </div>

  <div id="levelup-modal">
    <div class="modal-content">
      <h2 style="color: #333;">LEVEL UP!</h2>
      <div id="upgrade-list"></div>
    </div>
  </div>

  <div id="stats-modal">
    <div class="modal-content">
      <h2>PLAYER STATS</h2>
      <div id="stats-content" style="text-align: left; line-height: 1.6;"></div>
      <button class="btn" onclick="document.getElementById('stats-modal').style.display='none'">CLOSE</button>
    </div>
  </div>

  <div id="gameover-screen">
    <h1 style="color: #FF69B4; font-size: 40px;">GAME OVER</h1>
    <p id="final-score" style="color: white;"></p>
    <button class="btn" id="restart-btn">RESTART</button>
  </div>

  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.176.0/build/three.module.js"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';

    // --- CONFIG & CONSTANTS ---
    const COLORS = {
      player: 0x4ECDC4,
      ground: 0x7CFC00,
      enemySquare: 0xFF69B4,
      enemyTriangle: 0xFFD700,
      enemyRound: 0x9370DB,
      forest: 0x228B22,
      lake: 0x1E90FF,
      road: 0xD2B48C
    };

    let scene, camera, renderer, player;
    let enemies = [], projectiles = [], expGems = [], particles = [], meteors = [];
    let isPaused = false, isGameOver = false, frameCount = 0;
    
    const joystick = { x: 0, y: 0, active: false };
    const playerStats = {
      lvl: 1, exp: 0, expReq: 20, hp: 100, maxHp: 100,
      strength: 1, armor: 0, speed: 1.2, critChance: 0.1, critDmg: 1.5,
      atkSpeed: 1, kills: 0, hpRegen: 0
    };

    const weapons = {
      gun: { active: true, damage: 15, cooldown: 1000, lastShot: 0, range: 12 },
      sword: { active: false, damage: 30, cooldown: 1500, lastShot: 0 },
      aura: { active: false, damage: 5, cooldown: 500, lastShot: 0, range: 4 },
      meteor: { active: false, damage: 60, cooldown: 3000, lastShot: 0 }
    };

    // --- INITIALIZATION ---
    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xFFF0F5);
      scene.fog = new THREE.Fog(0xFFF0F5, 20, 60);

      const aspect = window.innerWidth / window.innerHeight;
      const d = 15;
      camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
      camera.position.set(20, 20, 20);
      camera.lookAt(0,0,0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.getElementById('game-container').appendChild(renderer.domElement);

      const ambient = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambient);
      const sun = new THREE.DirectionalLight(0xffffff, 0.8);
      sun.position.set(10, 20, 10);
      sun.castShadow = true;
      scene.add(sun);

      setupWorld();
      spawnPlayer();
      setupControls();
      animate(0);
    }

    function setupWorld() {
      // Ground
      const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshToonMaterial({ color: COLORS.ground }));
      ground.rotation.x = -Math.PI/2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Lake
      const lake = new THREE.Mesh(new THREE.CircleGeometry(12, 32), new THREE.MeshToonMaterial({ color: COLORS.lake }));
      lake.rotation.x = -Math.PI/2;
      lake.position.set(30, 0.05, -30);
      scene.add(lake);

      // Windmill
      const windmill = new THREE.Group();
      const tower = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 8), new THREE.MeshToonMaterial({ color: 0xF5F5DC }));
      tower.position.y = 4;
      windmill.add(tower);
      const blades = new THREE.Mesh(new THREE.BoxGeometry(10, 1, 0.5), new THREE.MeshToonMaterial({ color: 0x8B4513 }));
      blades.position.set(0, 7, 2.1);
      windmill.add(blades);
      windmill.position.set(-25, 0, -25);
      windmill.userData = { isWindmill: true, blades };
      scene.add(windmill);

      // Road
      const road = new THREE.Mesh(new THREE.PlaneGeometry(4, 100), new THREE.MeshToonMaterial({ color: COLORS.road }));
      road.rotation.x = -Math.PI/2;
      road.position.set(0, 0.02, 0);
      scene.add(road);
    }

    function spawnPlayer() {
      const geo = new THREE.SphereGeometry(0.6, 16, 16);
      const mat = new THREE.MeshToonMaterial({ color: COLORS.player });
      player = new THREE.Mesh(geo, mat);
      player.position.y = 0.6;
      player.castShadow = true;
      scene.add(player);
    }

    // --- GAME LOGIC ---
    function setupControls() {
      const zone = document.getElementById('joystick-zone');
      zone.addEventListener('touchstart', (e) => { joystick.active = true; });
      zone.addEventListener('touchmove', (e) => {
        const touch = e.touches[0];
        const rect = zone.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        joystick.x = (touch.clientX - cx) / (rect.width/2);
        joystick.y = (touch.clientY - cy) / (rect.height/2);
      });
      zone.addEventListener('touchend', () => { joystick.active = false; joystick.x = 0; joystick.y = 0; });

      document.getElementById('stats-btn').onclick = () => {
        isPaused = true;
        const content = document.getElementById('stats-content');
        content.innerHTML = `HP: ${Math.floor(playerStats.hp)}/${playerStats.maxHp}<br>STR: ${playerStats.strength.toFixed(1)}<br>ARMOR: ${playerStats.armor}%<br>KILLS: ${playerStats.kills}`;
        document.getElementById('stats-modal').style.display = 'flex';
      };

      document.getElementById('restart-btn').onclick = () => location.reload();
    }

    function spawnEnemy() {
      const type = Math.floor(Math.random() * 3);
      const angle = Math.random() * Math.PI * 2;
      const dist = 20;
      const ex = player.position.x + Math.cos(angle) * dist;
      const ez = player.position.z + Math.sin(angle) * dist;

      let geo;
      if(type === 0) geo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
      else if(type === 1) geo = new THREE.ConeGeometry(0.5, 1, 4);
      else geo = new THREE.SphereGeometry(0.5, 8, 8);

      const mat = new THREE.MeshToonMaterial({ color: [COLORS.enemySquare, COLORS.enemyTriangle, COLORS.enemyRound][type] });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(ex, 0.5, ez);
      scene.add(mesh);
      enemies.push({ mesh, hp: 100, speed: 0.05, type });
    }

    function levelUp() {
      isPaused = true;
      playerStats.lvl++;
      playerStats.exp = 0;
      playerStats.expReq += 15;
      
      const list = document.getElementById('upgrade-list');
      list.innerHTML = '';
      
      const pool = [
        { t: "STRENGTH", d: "Damage +15%", a: () => playerStats.strength += 0.15, c: "#000" },
        { t: "ARMOR", d: "Defense +10%", a: () => playerStats.armor += 10, c: "#FF0000" },
        { t: "REGEN", d: "Heal 2HP/s", a: () => playerStats.hpRegen += 2, c: "#FFFF00" },
        { t: "SPEED", d: "Move faster", a: () => playerStats.speed += 0.2, c: "#808080" }
      ];

      if(playerStats.lvl === 5) {
        pool.push({ t: "NEW: SWORD", d: "Frontal Slash", a: () => weapons.sword.active = true, c: "#4ECDC4" });
      }

      pool.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(upg => {
        const card = document.createElement('div');
        card.className = 'upgrade-card';
        card.style.backgroundColor = upg.c;
        card.innerHTML = `<div class="upgrade-title">${upg.t}</div><div class="upgrade-desc">${upg.d}</div>`;
        card.onclick = () => {
          upg.a();
          isPaused = false;
          document.getElementById('levelup-modal').style.display = 'none';
          updateHUD();
        };
        list.appendChild(card);
      });
      document.getElementById('levelup-modal').style.display = 'flex';
    }

    function updateHUD() {
      document.getElementById('hp-fill').style.width = `${(playerStats.hp/playerStats.maxHp)*100}%`;
      document.getElementById('exp-fill').style.width = `${(playerStats.exp/playerStats.expReq)*100}%`;
      document.getElementById('hp-text').innerText = `HP: ${Math.floor(playerStats.hp)}/${playerStats.maxHp}`;
      document.getElementById('lvl-text').innerText = `LVL: ${playerStats.lvl}`;
    }

    function animate(time) {
      requestAnimationFrame(animate);
      if(isPaused || isGameOver) return;

      frameCount++;

      // Movement
      if(joystick.active) {
        player.position.x += joystick.x * playerStats.speed * 0.1;
        player.position.z += joystick.y * playerStats.speed * 0.1;
        player.rotation.y = Math.atan2(joystick.x, joystick.y);
      }

      // Camera follow
      camera.position.x = player.position.x + 20;
      camera.position.z = player.position.z + 20;
      camera.lookAt(player.position);

      // Spawning
      if(frameCount % 120 === 0) spawnEnemy();

      // Enemy logic
      enemies.forEach((en, i) => {
        const dir = new THREE.Vector3().subVectors(player.position, en.mesh.position).normalize();
        en.mesh.position.addScaledVector(dir, en.speed);
        
        if(en.mesh.position.distanceTo(player.position) < 1) {
          playerStats.hp -= (33 * (1 - playerStats.armor/100));
          en.hp = 0; // Suicide attack
          if(playerStats.hp <= 0) {
            isGameOver = true;
            document.getElementById('gameover-screen').style.display = 'flex';
          }
          updateHUD();
        }
      });

      // Weapon: Gun
      if(time - weapons.gun.lastShot > weapons.gun.cooldown && enemies.length > 0) {
        const target = enemies[0].mesh.position;
        const bullet = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color: 0xff0}));
        bullet.position.copy(player.position);
        const bDir = new THREE.Vector3().subVectors(target, player.position).normalize();
        projectiles.push({ mesh: bullet, dir: bDir, life: 100 });
        scene.add(bullet);
        weapons.gun.lastShot = time;
      }

      // Projectile updates
      projectiles.forEach((p, pi) => {
        p.mesh.position.addScaledVector(p.dir, 0.4);
        p.life--;
        enemies.forEach(en => {
          if(p.mesh.position.distanceTo(en.mesh.position) < 0.8) {
            en.hp -= weapons.gun.damage * playerStats.strength;
            p.life = 0;
          }
        });
        if(p.life <= 0) {
          scene.remove(p.mesh);
          projectiles.splice(pi, 1);
        }
      });

      // Cleanup dead enemies
      enemies = enemies.filter(en => {
        if(en.hp <= 0) {
          scene.remove(en.mesh);
          playerStats.exp += 10;
          playerStats.kills++;
          if(playerStats.exp >= playerStats.expReq) levelUp();
          updateHUD();
          return false;
        }
        return true;
      });

      // Environment animation
      scene.children.forEach(c => {
        if(c.userData.isWindmill) c.userData.blades.rotation.z += 0.05;
      });

      renderer.render(scene, camera);
    }

    init();
  </script>
</body>
</html>
