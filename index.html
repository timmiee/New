<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterdrop Survivor – Dopamin Max</title>

<style>
html, body {
  margin:0;
  padding:0;
  overflow:hidden;
  background:#060608;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
canvas { display:block; }

/* HUD */
#hud {
  position:absolute;
  top:10px;
  left:10px;
  color:#e8e3d6;
  z-index:10;
  font-size:14px;
  text-shadow:0 0 6px rgba(0,0,0,0.9);
}
.hud-row {
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:4px;
}
#expStar {
  width:20px;
  height:20px;
  background:radial-gradient(circle at 30% 30%, #fff 0, #e8d9b0 45%, #a38f5a 70%, transparent 72%);
  clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
  filter:drop-shadow(0 0 6px #e8d9b0);
}

/* Level up overlay */
#levelUpOverlay {
  position:absolute;
  inset:0;
  background:rgba(5,5,8,0.9);
  backdrop-filter:blur(10px);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:20;
  color:#e8e3d6;
}

#levelUpTitle {
  font-size:28px;
  letter-spacing:2px;
  margin-bottom:18px;
  text-shadow:0 0 14px rgba(255,255,255,0.15);
}

#levelUpCards {
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  justify-content:center;
}

.level-card {
  width:150px;
  padding:12px;
  border-radius:14px;
  background:linear-gradient(145deg, #1a1a1d, #0e0e10);
  box-shadow:0 0 18px rgba(0,0,0,0.9);
  border:1px solid rgba(255,255,255,0.08);
  cursor:pointer;
  transform:scale(0.8);
  opacity:0;
  transition:transform 0.25s ease-out, opacity 0.25s ease-out, box-shadow 0.2s;
}
.level-card:hover {
  box-shadow:0 0 22px rgba(200,190,160,0.35);
  transform:scale(0.95) translateY(-6px);
}
.level-card-title {
  font-size:14px;
  font-weight:600;
  margin-bottom:6px;
  color:#f1ead8;
}
.level-card-desc {
  font-size:11px;
  opacity:0.85;
  color:#d6cfbb;
}

/* Flash */
#lvlupFlash {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) scale(0);
  font-size:42px;
  color:#f3e6b0;
  text-shadow:0 0 22px rgba(255,255,255,0.5);
  z-index:19;
  pointer-events:none;
}

/* Hint */
#hint {
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  color:#aaa;
  font-size:11px;
  text-shadow:0 0 6px #000;
  z-index:9;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.min.js"></script>
</head>
<body>

<div id="hud">
  <div class="hud-row">
    <span>HP: <span id="hp">100</span></span>
    <span>| LVL: <span id="lvl">1</span></span>
    <span>| KILLS: <span id="kills">0</span></span>
  </div>
  <div class="hud-row">
    <span>EXP:</span>
    <div id="expStar"></div>
  </div>
</div>

<div id="lvlupFlash">LEVEL UP</div>

<div id="levelUpOverlay">
  <div id="levelUpTitle">CHOOSE UPGRADE</div>
  <div id="levelUpCards"></div>
</div>

<div id="hint">Swipe för dash • WASD på dator</div>

<script>
/* ---------------- CORE STATE ---------------- */
let scene, camera, renderer;
let player, auraMesh;
let enemies=[], bullets=[], meteors=[], expGems=[], puddles=[], particles=[];

let lvl=1, kills=0, hp=100, exp=0, expToNext=12;
let keys={}, swipeStart=null;
let slowMotion=false, slowMotionFactor=1;
let baseDelta=1/60;

let cameraBase={x:0,y:30,z:30};
let cameraShake=0;

let playerWeapons={
  gun:1,
  double:0,
  aura:0,
  meteor:0
};

let lastShot=0, shotInterval=0.55;
let enemyTimer=0, enemyInterval=2;
let auraTimer=0;

/* ---------------- INIT ---------------- */
function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x060608);

  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
  camera.position.set(cameraBase.x,cameraBase.y,cameraBase.z);
  camera.lookAt(0,0,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(devicePixelRatio||1);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0x404050,0.9));
  const d=new THREE.DirectionalLight(0xffffff,1.1);
  d.position.set(20,30,10);
  scene.add(d);

  const ground=new THREE.Mesh(
    new THREE.CircleGeometry(90,64),
    new THREE.MeshStandardMaterial({color:0x111218,roughness:0.95})
  );
  ground.rotation.x=-Math.PI/2;
  scene.add(ground);

  player=new THREE.Mesh(
    new THREE.SphereGeometry(1.2,24,24),
    new THREE.MeshStandardMaterial({
      color:0x4da3ff,
      emissive:0x1b3fff,
      emissiveIntensity:0.35,
      roughness:0.35,
      metalness:0.4
    })
  );
  player.position.set(0,1.2,0);
  player.speed=10;
  player.dashCD=0;
  scene.add(player);

  auraMesh=new THREE.Mesh(
    new THREE.RingGeometry(2.5,3,48),
    new THREE.MeshBasicMaterial({
      color:0x9b5dff,
      transparent:true,
      opacity:0,
      side:THREE.DoubleSide
    })
  );
  auraMesh.rotation.x=-Math.PI/2;
  auraMesh.position.y=0.05;
  scene.add(auraMesh);

  window.addEventListener('resize',()=> {
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

  window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
  window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

  window.addEventListener('touchstart',e=>swipeStart=e.touches[0]);
  window.addEventListener('touchend',e=>{
    if(!swipeStart)return;
    const dx=e.changedTouches[0].clientX-swipeStart.clientX;
    const dy=e.changedTouches[0].clientY-swipeStart.clientY;
    dash(dx,dy);
    swipeStart=null;
  });

  animate(0);
}

/* ---------------- DASH ---------------- */
function dash(dx,dy){
  if(player.dashCD>0)return;
  const l=Math.hypot(dx,dy);
  if(l<20)return;
  player.position.x+=dx/l*6;
  player.position.z+=-dy/l*6;
  player.dashCD=0.6;
  spawnSplash(player.position,0x4da3ff,14);
}

/* ---------------- ENEMY ---------------- */
function spawnEnemy(){
  const types=[
    {c:0xff4d4d,s:1.1,sp:4},
    {c:0x4dff88,s:1.0,sp:3.6},
    {c:0xffd94d,s:0.9,sp:4.6}
  ];
  const t=types[Math.floor(Math.random()*types.length)];
  const e=new THREE.Mesh(
    new THREE.SphereGeometry(t.s,16,16),
    new THREE.MeshStandardMaterial({color:t.c,roughness:0.5})
  );
  const a=Math.random()*Math.PI*2;
  const r=55;
  e.position.set(Math.cos(a)*r,t.s,Math.sin(a)*r);
  e.speed=t.sp;
  e.hp=3+lvl*0.3;
  e.col=t.c;
  scene.add(e);
  enemies.push(e);
}

/* ---------------- PARTICLES ---------------- */
function spawnSplash(pos,color,count){
  for(let i=0;i<count;i++){
    const p=new THREE.Mesh(
      new THREE.SphereGeometry(0.12,6,6),
      new THREE.MeshBasicMaterial({color,transparent:true})
    );
    p.position.copy(pos);
    p.vel=new THREE.Vector3(
      (Math.random()-0.5)*6,
      Math.random()*5,
      (Math.random()-0.5)*6
    );
    p.life=1.2+Math.random()*0.8;
    scene.add(p);
    particles.push(p);
  }
}

function spawnPuddle(pos,color){
  const p=new THREE.Mesh(
    new THREE.CircleGeometry(1.6+Math.random(),20),
    new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.65})
  );
  p.rotation.x=-Math.PI/2;
  p.position.set(pos.x,0.02,pos.z);
  p.life=6;
  p.maxLife=6;
  scene.add(p);
  puddles.push(p);
}

/* ---------------- BULLETS ---------------- */
function shoot(){
  const t=performance.now()/1000;
  if(t-lastShot<shotInterval)return;
  lastShot=t;

  const dirs=[new THREE.Vector3(0,0,-1)];
  if(playerWeapons.double>0){
    dirs.push(new THREE.Vector3(0.18,0,-1).normalize());
    dirs.push(new THREE.Vector3(-0.18,0,-1).normalize());
  }

  dirs.forEach(d=>{
    const b=new THREE.Mesh(
      new THREE.SphereGeometry(0.25,8,8),
      new THREE.MeshBasicMaterial({color:0x4da3ff})
    );
    b.position.copy(player.position);
    b.dir=d;
    b.speed=32;
    b.life=2;
    scene.add(b);
    bullets.push(b);
  });
}

/* ---------------- LEVEL / EXP ---------------- */
function addExp(v){
  exp+=v;
  if(exp>=expToNext){
    exp-=expToNext;
    levelUp();
  }
}

function levelUp(){
  lvl++;
  document.getElementById('lvl').textContent=lvl;
  hp+=6;
  document.getElementById('hp').textContent=Math.floor(hp);
  expToNext=Math.floor(expToNext*1.35);

  const flash=document.getElementById('lvlupFlash');
  flash.style.transition='none';
  flash.style.transform='translate(-50%,-50%) scale(0)';
  requestAnimationFrame(()=>{
    flash.style.transition='transform 0.35s ease-out';
    flash.style.transform='translate(-50%,-50%) scale(1.4)';
    setTimeout(()=>flash.style.transform='translate(-50%,-50%) scale(0)',500);
  });

  slowMotion=true;
  slowMotionFactor=0.25;
  cameraShake=0.6;

  if([5,10,15,20].includes(lvl)) showUpgrades();
  else exitLevelUp();
}

/* ---------------- UPGRADES ---------------- */
function showUpgrades(){
  const cont=document.getElementById('levelUpCards');
  cont.innerHTML='';

  const opts=[];

  opts.push({
    t:'Gun Tier',
    d:'Snabbare eld, mer skada.',
    a:()=>{playerWeapons.gun++;shotInterval=Math.max(0.22,shotInterval-0.05);}
  });

  opts.push({
    t:'Double Barrel',
    d:'Fler projektiler, bredare spridning.',
    a:()=>{playerWeapons.double++;}
  });

  opts.push({
    t:'Aura',
    d:'Skadar fiender nära dig.',
    a:()=>{
      playerWeapons.aura++;
      auraMesh.material.opacity=0.35;
      auraMesh.scale.setScalar(1+playerWeapons.aura*0.25);
    }
  });

  if(lvl>=10){
    opts.push({
      t:'Meteor',
      d:'Förintelse från ovan.',
      a:()=>playerWeapons.meteor++
    });
  }

  opts.slice(0,4).forEach(o=>{
    const c=document.createElement('div');
    c.className='level-card';
    c.innerHTML=`<div class="level-card-title">${o.t}</div>
                 <div class="level-card-desc">${o.d}</div>`;
    c.onclick=()=>{o.a();hideUpgrades();};
    cont.appendChild(c);
    requestAnimationFrame(()=>{
      c.style.opacity=1;
      c.style.transform='scale(1)';
    });
  });

  document.getElementById('levelUpOverlay').style.display='flex';
}

function hideUpgrades(){
  document.getElementById('levelUpOverlay').style.display='none';
  exitLevelUp();
}

function exitLevelUp(){
  slowMotion=false;
  slowMotionFactor=1;
}

/* ---------------- LOOP ---------------- */
let last=0;
function animate(t){
  requestAnimationFrame(animate);
  const dt=((t-last)/1000||baseDelta)*(slowMotion?slowMotionFactor:1);
  last=t;

  if(cameraShake>0){
    camera.position.x=(Math.random()-0.5)*cameraShake;
    camera.position.z=cameraBase.z+(Math.random()-0.5)*cameraShake;
    cameraShake*=0.9;
  } else {
    camera.position.set(0,cameraBase.y,cameraBase.z);
  }

  if(player.dashCD>0)player.dashCD-=dt;

  let mx=0,mz=0;
  if(keys['w'])mz--;
  if(keys['s'])mz++;
  if(keys['a'])mx--;
  if(keys['d'])mx++;
  const l=Math.hypot(mx,mz);
  if(l){
    player.position.x+=mx/l*player.speed*dt;
    player.position.z+=mz/l*player.speed*dt;
  }

  enemyTimer+=dt;
  if(enemyTimer>enemyInterval){
    spawnEnemy();
    enemyTimer=0;
    enemyInterval=Math.max(0.6,enemyInterval*0.98);
  }

  enemies.forEach((e,i)=>{
    const d=new THREE.Vector3().subVectors(player.position,e.position);
    const dist=d.length();
    d.normalize();
    e.position.addScaledVector(d,e.speed*dt);
    if(dist<1.4){
      hp-=12*dt;
      document.getElementById('hp').textContent=Math.floor(hp);
    }
  });

  shoot();

  bullets=bullets.filter(b=>{
    b.position.addScaledVector(b.dir,b.speed*dt);
    b.life-=dt;
    for(let i=enemies.length-1;i>=0;i--){
      if(b.position.distanceTo(enemies[i].position)<1.1){
        const e=enemies[i];
        e.hp-=1+playerWeapons.gun*0.4;
        spawnSplash(e.position,e.col,10);
        if(e.hp<=0){
          spawnPuddle(e.position,e.col);
          addExp(1);
          scene.remove(e);
          enemies.splice(i,1);
          kills++;
          document.getElementById('kills').textContent=kills;
        }
        scene.remove(b);
        return false;
      }
    }
    if(b.life<=0){scene.remove(b);return false;}
    return true;
  });

  if(playerWeapons.aura>0){
    auraMesh.position.copy(player.position);
    auraMesh.material.opacity=0.3+0.1*Math.sin(t*0.005);
    auraTimer+=dt;
    if(auraTimer>0.4){
      auraTimer=0;
      enemies.forEach((e,i)=>{
        if(e.position.distanceTo(player.position)<3.2){
          e.hp-=0.8+playerWeapons.aura*0.5;
          spawnSplash(e.position,0x9b5dff,6);
          if(e.hp<=0){
            spawnPuddle(e.position,e.col);
            addExp(1);
            scene.remove(e);
            enemies.splice(i,1);
          }
        }
      });
    }
  }

  particles=particles.filter(p=>{
    p.life-=dt;
    p.position.addScaledVector(p.vel,dt);
    p.material.opacity=p.life/2;
    if(p.life<=0){scene.remove(p);return false;}
    return true;
  });

  puddles=puddles.filter(p=>{
    p.life-=dt;
    p.material.opacity=0.65*(p.life/p.maxLife);
    if(p.life<=0){scene.remove(p);return false;}
    return true;
  });

  renderer.render(scene,camera);
}

/* ---------------- START ---------------- */
init();
</script>
</body>
</html>