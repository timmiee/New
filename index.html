<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Water Drop Survivor - Enhanced FX</title>
  <style>
    body {
      margin: 0; padding: 0; overflow: hidden;
      background-color: #FFF0F5;
      font-family: 'M PLUS Rounded 1c', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      touch-action: none; user-select: none; -webkit-user-select: none;
    }
    #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
    }
    .hud-top { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
    .bar-container {
      width: 200px; height: 20px; background: rgba(0, 0, 0, 0.2);
      border-radius: 10px; border: 2px solid #fff; overflow: hidden; position: relative;
    }
    .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
    #hp-bar .bar-fill { background: #FF69B4; width: 100%; }
    #exp-bar .bar-fill { background: #4ECDC4; width: 0%; }
    .stat-text {
      color: #FF69B4; font-weight: bold; text-shadow: 1px 1px 0 #fff; font-size: 14px;
    }
    #joystick-zone {
      position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
      width: 150px; height: 150px; pointer-events: auto;
    }
    #levelup-modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 240, 245, 0.9); display: none;
      flex-direction: column; align-items: center; justify-content: center;
      pointer-events: auto; z-index: 20;
    }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 20px; border: 4px solid #FF69B4;
      width: 80%; max-width: 400px; text-align: center;
    }
    .upgrade-card {
      background: #E6E6FA; margin: 10px 0; padding: 15px; border-radius: 15px;
      border: 2px solid #9370DB; cursor: pointer;
    }
    .damage-number {
      position: absolute; color: #fff; font-weight: bold; font-size: 20px;
      pointer-events: none; text-shadow: 0 0 3px #FF0000;
      animation: floatUp 1s forwards;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }
    .btn {
      background: #FF69B4; color: white; border: none; padding: 15px 30px;
      font-size: 20px; border-radius: 50px; margin-top: 20px; font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="game-container"></div>
  <div id="ui-layer">
    <div class="hud-top">
      <div class="bar-container"><div class="bar-fill" id="hp-fill"></div></div>
      <div class="stat-text" id="hp-text">HP: 100/100</div>
      <div class="bar-container" style="border-color: #4ECDC4;"><div class="bar-fill" id="exp-fill"></div></div>
      <div class="stat-text" id="lvl-text" style="color: #4ECDC4;">LVL: 1</div>
      <div class="stat-text" id="score-text" style="color: #9370DB;">KILLS: 0</div>
    </div>
    <div id="joystick-zone"></div>
  </div>

  <div id="levelup-modal">
    <div class="modal-content">
      <h2>LEVEL UP!</h2>
      <div id="upgrade-list"></div>
    </div>
  </div>

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.176.0/build/three.module.js" } }
  </script>

  <script type="module">
    import * as THREE from 'three';

    const COLORS = {
      bg: 0xFFF0F5, player: 0x4ECDC4, enemySquare: 0xFF69B4,
      enemyTriangle: 0xFFD700, enemyRound: 0x9370DB, ground: 0x7CFC00,
      forest: 0x98FB98, lake: 0x1E90FF, cabin: 0xDEB887, exp: 0x00FFFF
    };

    let scene, camera, renderer, player;
    let enemies = [], projectiles = [], expGems = [], particles = [], meteors = [];
    let isPaused = false, isGameOver = false, frameCount = 0, gameTime = 0;
    const joystick = { x: 0, y: 0, active: false, originX: 0, originY: 0 };
    const playerStats = { lvl: 1, exp: 0, expReq: 20, hp: 100, maxHp: 100, strength: 1, armor: 0, walkSpeed: 25, kills: 0, damage: 1, atkSpeed: 1, critChance: 0.1, critDmg: 1.5 };
    const weapons = { gun: { active: true, damage: 15, cooldown: 1000, lastShot: 0, range: 12 }, sword: { active: false, damage: 30, cooldown: 1500, lastShot: 0, range: 3.5 }, aura: { active: false, damage: 5, cooldown: 500, lastShot: 0, range: 4 }, meteor: { active: false, damage: 60, cooldown: 2500, lastShot: 0, area: 5 } };

    // --- NEW: PARTICLE CLASS ---
    class Particle {
      constructor(pos, color, scale = 0.2) {
        const geo = new THREE.BoxGeometry(scale, scale, scale);
        const mat = new THREE.MeshBasicMaterial({ color: color });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.copy(pos);
        scene.add(this.mesh);
        this.vel = new THREE.Vector3((Math.random()-0.5)*0.3, Math.random()*0.3, (Math.random()-0.5)*0.3);
        this.life = 30 + Math.random()*20;
      }
      update() {
        this.life--;
        this.mesh.position.add(this.vel);
        this.vel.y -= 0.015; // Gravity
        if(this.mesh.position.y < 0.1) { this.mesh.position.y = 0.1; this.vel.set(0,0,0); }
        if(this.life <= 0) { scene.remove(this.mesh); return false; }
        return true;
      }
    }

    class Player {
      constructor() {
        this.mesh = new THREE.Mesh(new THREE.SphereGeometry(0.5, 16, 16), new THREE.MeshToonMaterial({ color: COLORS.player }));
        this.mesh.position.y = 0.5;
        scene.add(this.mesh);
        this.isDashing = false; this.dashTime = 0; this.dashVec = new THREE.Vector3();
      }
      update(dt) {
        if (joystick.active) {
          const speed = 0.12 * (playerStats.walkSpeed / 25);
          this.mesh.position.x += joystick.x * speed;
          this.mesh.position.z += joystick.y * speed;
          this.mesh.rotation.y = Math.atan2(joystick.x, joystick.y);
          const s = 1 + (0.12 * 2); this.mesh.scale.set(1/Math.sqrt(s), 1/Math.sqrt(s), s);
        } else { this.mesh.scale.set(1,1,1); }
        camera.position.set(this.mesh.position.x, 20, this.mesh.position.z + 20);
        camera.lookAt(this.mesh.position);
      }
      takeDamage(amount) {
        playerStats.hp -= amount * (1 - playerStats.armor/100);
        updateUI();
        for(let i=0; i<5; i++) particles.push(new Particle(this.mesh.position, COLORS.player));
        if (playerStats.hp <= 0) location.reload();
      }
    }

    class Enemy {
      constructor(type, x, z) {
        this.type = type;
        this.color = type === 0 ? COLORS.enemySquare : (type === 1 ? COLORS.enemyTriangle : COLORS.enemyRound);
        let geo = type === 0 ? new THREE.BoxGeometry(0.8,0.8,0.8) : (type === 1 ? new THREE.ConeGeometry(0.5,1,8) : new THREE.SphereGeometry(0.5,12,12));
        this.mesh = new THREE.Mesh(geo, new THREE.MeshToonMaterial({ color: this.color }));
        this.mesh.position.set(x, 0.5, z);
        scene.add(this.mesh);
        this.hp = type === 0 ? 150 : (type === 1 ? 40 : 80);
        this.speed = type === 1 ? 0.08 : 0.05;
      }
      update() {
        const dir = new THREE.Vector3().subVectors(player.mesh.position, this.mesh.position).normalize();
        this.mesh.position.add(dir.multiplyScalar(this.speed));
        if(this.mesh.position.distanceTo(player.mesh.position) < 1) player.takeDamage(0.5);
      }
      // --- UPGRADED: TAKE DAMAGE WITH FX ---
      takeDamage(amount) {
        this.hp -= amount;
        createDamageNumber(Math.floor(amount), this.mesh.position);
        
        // FX: Hit Flash
        const orig = this.mesh.material.color.getHex();
        this.mesh.material.color.setHex(0xFFFFFF);
        setTimeout(() => { if(this.mesh) this.mesh.material.color.setHex(orig); }, 50);

        // FX: Hit Particles (Drops)
        for(let i=0; i<4; i++) particles.push(new Particle(this.mesh.position, this.color, 0.15));

        if (this.hp <= 0) {
          // FX: Death Explosion
          for(let i=0; i<12; i++) particles.push(new Particle(this.mesh.position, this.color, 0.25));
          this.die();
        }
      }
      die() {
        scene.remove(this.mesh);
        enemies = enemies.filter(e => e !== this);
        spawnExp(this.mesh.position);
        playerStats.kills++;
        updateUI();
      }
    }

    // --- FUNCTIONS ---
    function spawnExp(pos) {
      const gem = new THREE.Mesh(new THREE.OctahedronGeometry(0.3), new THREE.MeshToonMaterial({ color: COLORS.exp }));
      gem.position.set(pos.x, 0.5, pos.z);
      scene.add(gem);
      expGems.push(gem);
    }

    function createDamageNumber(amt, pos) {
      const div = document.createElement('div'); div.className = 'damage-number'; div.innerText = amt;
      const v = pos.clone().project(camera);
      div.style.left = (v.x*.5+.5)*window.innerWidth+'px'; div.style.top = (-(v.y*.5)+.5)*window.innerHeight+'px';
      document.body.appendChild(div); setTimeout(() => div.remove(), 1000);
    }

    function updateUI() {
      document.getElementById('hp-fill').style.width = (playerStats.hp/playerStats.maxHp)*100+"%";
      document.getElementById('exp-fill').style.width = (playerStats.exp/playerStats.expReq)*100+"%";
      document.getElementById('score-text').innerText = "KILLS: " + playerStats.kills;
    }

    // --- MAIN ---
    function init() {
      scene = new THREE.Scene(); scene.background = new THREE.Color(COLORS.bg);
      camera = new THREE.OrthographicCamera(-20, 20, 20, -20, 1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('game-container').appendChild(renderer.domElement);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshToonMaterial({ color: COLORS.ground }));
      ground.rotation.x = -Math.PI/2; scene.add(ground);
      player = new Player();
      setupInputs();
      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      if(isPaused) return;
      frameCount++; gameTime += 0.016;
      player.update(0.016);
      
      if(frameCount % 300 === 0) {
        const a = Math.random()*Math.PI*2;
        enemies.push(new Enemy(Math.floor(Math.random()*3), player.mesh.position.x+Math.cos(a)*25, player.mesh.position.z+Math.sin(a)*25));
      }

      // Gun Weapon Logic
      if(frameCount % 60 === 0 && enemies.length > 0) {
        enemies[0].takeDamage(weapons.gun.damage * playerStats.strength);
      }

      enemies.forEach(e => e.update());
      particles = particles.filter(p => p.update() !== false);
      expGems.forEach(g => {
        if(g.position.distanceTo(player.mesh.position) < 1) {
          scene.remove(g); expGems = expGems.filter(gem => gem !== g);
          playerStats.exp += 10; if(playerStats.exp >= playerStats.expReq) { playerStats.lvl++; playerStats.exp = 0; }
          updateUI();
        }
      });

      renderer.render(scene, camera);
    }

    function setupInputs() {
      const zone = document.getElementById('joystick-zone');
      zone.addEventListener('touchstart', e => { joystick.active = true; joystick.originX = e.touches[0].clientX; joystick.originY = e.touches[0].clientY; });
      window.addEventListener('touchmove', e => {
        if(!joystick.active) return;
        const dx = e.touches[0].clientX - joystick.originX; const dy = e.touches[0].clientY - joystick.originY;
        const d = Math.sqrt(dx*dx+dy*dy); joystick.x = dx/Math.max(d,1); joystick.y = dy/Math.max(d,1);
      });
      window.addEventListener('touchend', () => { joystick.active = false; joystick.x = 0; joystick.y = 0; });
    }

    init();
  </script>
</body>
</html>
